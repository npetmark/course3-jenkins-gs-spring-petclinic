pipeline {
    agent { label 'General' }
        stages {
                stage("deploy") {
                    agent { 
                        docker { 
                            image 'nmark/petclinic'
                            args '--name petclinic-deploy'
                        }
                    }
                    steps {
                        slackSend message: "Build Started - ${env.JOB_NAME} ${env.BUILD_NUMBER} (<${env.BUILD_URL}|Link>)"
                        copyArtifacts filter: '**/*.jar', fingerprintArtifacts: true, projectName: 'petclinic-ci', target: './deploy-petclinic'
                        sh 'sleep 80'
                        sh 'docker exec -u 0 petclinic docker cp -f petclinic-deploy:/var/jenkins_home/workspace/petclinic-cd/deploy-petclinic/target/spring-petclinic-3.1.0-SNAPSHOT.jar ./'
                        sh "docker exec petclinic java -Dserver.port=9000 -jar ./spring-petclinic-3.1.0-SNAPSHOT.jar &"
                    }
                }
            }
        post {
            always {
                emailext body: "${env.BUILD_URL}\n${currentBuild.absoluteUrl}",
                    to: 'nikolay.markov@technocloudlab.com',
                    recipientProviders: [previous()], 
                    subject: "${currentBuild.currentResult}: Job ${env.JOB_NAME} [${env.BUILD_NUMBER}]"

                slackSend message: "Build Completed - ${currentBuild.currentResult}: ${env.JOB_NAME} ${env.BUILD_NUMBER} (<${env.BUILD_URL}|Link>)"
            }   
        }
}