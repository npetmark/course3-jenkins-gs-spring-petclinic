pipeline {
    stages {
        agent none
            stage("deploy") {
                agent { 
                    docker { 
                        image 'nmark/petclinic'
                        args '--name petclinic-deploy'
                    }
                }
                steps {
                    script{
                        // withEnv(['JENKINS_NODE_COOKIE=dontKillMe']) {
                        copyArtifacts filter: '**/*.jar', fingerprintArtifacts: true, projectName: 'scm-declarative', selector: lastSuccessful(), target: './var/jenkins_home/workspace/scm-declarative/target'
                        sh 'docker exec -u 0 petclinic docker cp petclinic-deploy:./var/jenkins_home/workspace/scm-declarative/target/spring-petclinic-3.1.0-SNAPSHOT.jar .'
                        sh "docker exec petclinic java -Dserver.port=9000 -jar ./spring-petclinic-3.1.0-SNAPSHOT.jar &"
                    // }
                }
            }
        }   
    }
}